#!/bin/bash
# Handle URLs by launching appropriate workflow
# Usage: handle-workflow-url <url>

set -euo pipefail

# Source shared utilities
source "$(dirname "$0")/../shared.sh"

url="$1"

if [ -z "$url" ]; then
    echo "Usage: $0 <url>" >&2
    exit 1
fi

# Determine which workflow to launch based on URL pattern
workflow_name=""
workflow_args=""
show_mode_menu=false

case "$url" in
    *app.shortcut.com/*/story/*)
        workflow_name="start-shortcut-story"
        workflow_args="$url"
        show_mode_menu=true
        ;;

    *github.com/notifications*)
        workflow_name="process-github-notifications"
        workflow_args=""
        ;;

    *github.com/*/pull/*)
        workflow_name="review-github-pr"
        workflow_args="$url"
        show_mode_menu=true
        ;;

    *github.com/pulls*)
        workflow_name="review-github-prs"
        workflow_args=""
        ;;

    *)
        # Unknown URL type
        echo "No workflow configured for URL: $url" >&2
        exit 1
        ;;
esac

# Show mode selection menu if applicable (always required for PR/story workflows)
if [ "$show_mode_menu" = true ]; then
    # Determine which session to show menu in
    if [ -n "${TMUX:-}" ]; then
        # We're already in tmux, show menu in current session
        menu_target=""
    else
        # Not in tmux, find an active session
        active_session=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | head -n 1)
        if [ -z "$active_session" ]; then
            echo "Error: No active tmux session found" >&2
            exit 1
        fi
        menu_target="-t $active_session"
    fi

    # Show menu for mode selection
    # Run workflow in a popup so user can see progress
    tmux display-menu $menu_target -T "Checkout Mode" \
        "Main Repository" "r" "display-popup -E -w 80% -h 80% 'bash $(dirname "$0")/launch-workflow \"$workflow_name\" \"$url\"'" \
        "Worktree (isolated)" "w" "display-popup -E -w 80% -h 80% 'bash $(dirname "$0")/launch-workflow \"${workflow_name}-worktree\" \"$url\"'" \
        "" \
        "Cancel" "q" ""
    exit 0
fi

# If we're not inside tmux, find an active session and run the workflow there
if [ -z "${TMUX:-}" ]; then
    # Get the first active tmux session
    active_session=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | head -n 1)

    if [ -n "$active_session" ]; then
        # Display a popup showing the workflow is starting
        # Source .profile to get environment variables like WORKFLOW_AI_CLI
        tmux display-popup -t "$active_session" -E -w 80% -h 80% \
            "source ~/.profile 2>/dev/null || true; export WORKFLOW_AI_CLI; $(dirname "$0")/start-workflow '$workflow_name' '$workflow_args'"
    else
        # No tmux session found, run normally (will create new session but won't attach)
        "$(dirname "$0")/start-workflow" "$workflow_name" $workflow_args
    fi
else
    # We're already inside tmux, run normally
    "$(dirname "$0")/start-workflow" "$workflow_name" $workflow_args
fi
