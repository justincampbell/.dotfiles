#!/bin/bash
# Create a worktree for a GitHub PR

set -euo pipefail

# Source shared utilities
source "$(dirname "$0")/../shared.sh"

# Get GitHub PR URL from argument
pr_url="$1"

if [ -z "$pr_url" ]; then
    echo "Usage: checkout-github-pr <github-pr-url>" >&2
    exit 1
fi

# Parse GitHub PR URL
read -r org repo pr_number < <(parse_github_url "$pr_url" true)
if [ $? -ne 0 ]; then
    exit 1
fi

# Get base repository directory
base_repo=$(get_github_repo_path "$org" "$repo")

if [ ! -d "$base_repo" ]; then
    echo "Error: Repository not found at $base_repo" >&2
    exit 1
fi

# Change to base repository directory
cd "$base_repo"

# Get PR info using gh CLI to get the branch name
echo "Getting PR #$pr_number info..." >&2
pr_info=$(gh pr view "$pr_number" --json headRefName)
branch_name=$(echo "$pr_info" | yq -r '.headRefName')

if [ -z "$branch_name" ] || [ "$branch_name" = "null" ]; then
    echo "Error: Failed to get branch name for PR #$pr_number" >&2
    exit 1
fi

echo "PR branch: $branch_name" >&2

# Fetch the PR branch first
echo "Fetching PR branch..." >&2
git fetch origin "pull/$pr_number/head:$branch_name" 2>/dev/null || true

# Use ensure-git-worktree to create the worktree
worktree_path=$("$(dirname "$0")/ensure-git-worktree" "$branch_name")

# Output the worktree directory (for task chaining)
echo "$worktree_path"